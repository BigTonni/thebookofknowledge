# Работа над проектами: работа с кодом

*Оригинальный пост в блоге: [Advent, Episode 10: Работа над проектами, show me the code](http://blog.evercodelab.com/advent-episode10-projects-show-me-the-code/)*

> «Любая достаточно развитая магия неотличима от технологии». — перевернутый третий закон Кларка

Когда мы предоставляем свои услуги, мы знаем, что нас понимают далеко не всегда и не сразу. Поэтому учимся не только быть лучше в «своей теме», но и говорить на языке клиента.

## История изменений

Написание кода — одна из основных задач в нашей работе. Та область, которую совершенствовать можно до бесконечности, если вовремя не остановиться.

Код всех наших проектов [версионируется](https://ru.wikipedia.org/wiki/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F_%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D1%8F%D0%BC%D0%B8) и ведется на [Github](http://github.com). У нас есть [аккаунт организации](https://github.com/EvercodeLab) с возможностью создавать приватные репозитории. Для каждого проекта такой создается с самого начала.

При создании выдаются права на чтение-запись специально созданной группе *EvercodeLab/team*, в которой состоят все сотрудники фирмы. Т.е. у каждого сотрудника есть доступ ко всем проектам независимо от того, участвует он в нем или нет. Для проекта может быть создана еще одна группа доступа специально для клиентов и задействованных людей извне.

Помимо этого на все репозитории у нас подключены оповещения в специальную комнату *Github* в нашем рабочем чате. На любой коммит, пуш, комментарий к коду, форк и прочее падает сообщение, которое все видят.

<img align="center"  src="http://blog.evercodelab.com/assets/images/advent/10/notify.jpg" data-caption="оповещения c github в hipchat" />

Историю мы любим держать в порядке. Вот, например, некоторые рекомендации по коммитам:

* не стоит делать большие коммиты
* сообщения о коммитах должны быть на английском языке
* в сообщении о коммите желательно указывать номер задачи в YouTrack
* сообщение о коммите должно содержать короткое и понятное описание внесенных изменений
* правки code standards на весь проект стоит делать отдельным коммитом

Также мы уделяем внимание и тому, что попадает в историю, а что нет. Для `.gitignore` есть такие советы:

* в `.gitignore` проекта должны быть только записи, специфичные для этого проекта
* файлы, относящиеся к локальному рабочему окружению должны оставаться в глобальном игноре (например, `.idea` или `.DS_Store`)
* в репозиторий не должны попадать пользовательские данные, кэш и логи
* в репозитории не стоит хранить специфичные для окружения настройки (доступы к базе, ключи к API и подобное)

## Code Standards

На код мы смотрим много, причем не только на свой, но и на код коллег. Гораздо удобнее и приятнее, если стиль оформления кода при этом привычен и не отличается в рамках проекта и между проектами на одном и том же фреймворке. Поэтому у каждого проекта есть *coding standards*.

Например, для проектов на Symfony2 мы придерживаемся [ее стандартов](http://symfony.com/doc/current/contributing/code/standards.html), которые в свою очередь полагаются на рекомендации [PHP Framework Interop Group](http://www.php-fig.org/).

Чтобы контроллировать себя и не править оформление руками мы активно используем [PHP Coding Standards Fixer](http://cs.sensiolabs.org/).

## Git workflow

За все время работы мы попробовали или посмотрели разные рекомендуемые и придуманные workflow для Git. Подобных алгоритмов для совместной работы в рамках одного репозитория довольно много и каждый из них имеет право на существование, так как в разных ситуациях удобство разных подходов различно. Наш текущий [Git workflow](../code_work/git_workflow.md) есть в отдельной статье. Здесь перечислены основные принципы:

* в основе процесса лежит использование feature branches и *pull requests*
* на каждую новую фичу или задачу мы создаем отдельную ветку от текущей основной
* если проект еще не запущен, то основная ветка — *master*
* после запуска мы как правило отделяем основную ветку для разработки — *development*, а в *master* код попадает перед релизом в прод
* в рамках ветки идет обычная работа над кодом, создаются коммиты
* когда фича готова, создается *pull request* и запрашивается code review и прочий фидбек; получить code review — обязанность автора pull request'а
* после обсуждения и доработок *pull request* мерджится в *master* или *development*, откуда уже деплоится на соответствующий сервер

## Code review

Ревью кода — неотъемлемая часть процесса, которая сильно помогает избегать глупых ошибок и улучшать качество кода. Комментарии к коду мы оставляем непосредственно на github в коммитах или пулл реквестах. Тут же можно обсудить спорные решения, предложить альтернативные. Code review осуществляется любым другим человеком в команде, отличным от автора кода.

Очень хорошие «правила этикета» для ревью кода можно почитать в [руководстве компании Thoughtbot](https://github.com/thoughtbot/guides/tree/master/code-review)

## Deploy

Готовый и попавший в основную ветку код мы сразу заливаем на сервер. Как правило, сначала на тестовый для проверки и демонстрации, потом на прод. Все это делает непосредственно автор изменений сам.

Так как процесс этот может происходить часто, иногда по несколько раз в день, автоматизировать его было очень хорошей идеей.

Для Symfony2 проектов мы активно используем [Capifony](http://capifony.org/), для RoR и других соответственно ее предка — Capistrano.

## Автоматизированные тесты

Мы активно используем PHPUnit и Behat, экспериментируем с PHPSpec.

Какие-то тесты есть у каждого проекта. Обязательным на сейчас является написание функционального теста на каждый action, т.е. по сути страницу.
